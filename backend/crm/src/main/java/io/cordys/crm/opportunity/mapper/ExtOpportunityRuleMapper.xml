<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.cordys.crm.opportunity.mapper.ExtOpportunityRuleMapper">
    <select id="list" parameterType="io.cordys.common.dto.BasePageRequest" resultType="io.cordys.crm.opportunity.dto.OpportunityRuleDTO">
        select * from opportunity_rule
        where organization_id = #{orgId}
        <include refid="filters">
            <property name="filters" value="request.filters"/>
        </include>
        <include refid="io.cordys.common.mapper.CommonMapper.sort">
            <property name="sort" value="request.sort"/>
            <property name="prefix" value=""/>
            <property name="defaultSort" value="create_time desc"/>
        </include>
    </select>

    <select id="getRuleByScopeIds" resultType="io.cordys.crm.opportunity.domain.OpportunityRule">
        select * from opportunity_rule where organization_id = #{orgId} and
        <foreach collection="ids" item="id" open="(" close=")" separator="or">
            scope_id like concat('%', #{id}, '%')
        </foreach>
    </select>

    <sql id="filters">
        <if test="${filters} != null and ${filters}.size() > 0">
            <trim prefix="and">
                <foreach collection="${filters}" item="condition" open="(" close=")" index="i" separator="and">
                    <if test="condition.name == 'recycled'">
                        <include refid="io.cordys.common.mapper.CommonMapper.condition">
                            <property name="condition" value="condition"/>
                            <property name="column" value="opportunity_rule.auto"/>
                        </include>
                    </if>
                    <if test="condition.name == 'status'">
                        <include refid="io.cordys.common.mapper.CommonMapper.condition">
                            <property name="condition" value="condition"/>
                            <property name="column" value="opportunity_rule.enable"/>
                        </include>
                    </if>
                </foreach>
            </trim>
        </if>
    </sql>
</mapper>