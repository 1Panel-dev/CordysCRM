<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.cordys.crm.follow.mapper.ExtFollowUpPlanMapper">

    <select id="selectList" resultType="io.cordys.crm.follow.dto.response.FollowUpPlanListResponse">
        SELECT
        id,
        customer_id,
        opportunity_id,
        type,
        clue_id,
        content,
        owner,
        contact_id,
        estimated_time,
        create_time,
        update_time,
        create_user,
        update_user,
        CASE
        WHEN `status` = 'CANCELLED' THEN 'CANCELLED'
        WHEN UNIX_TIMESTAMP(CURDATE())*1000 <![CDATA[<]]> estimated_time THEN 'PREPARED'
        WHEN UNIX_TIMESTAMP(CURDATE())*1000 = estimated_time THEN 'UNDERWAY'
        WHEN UNIX_TIMESTAMP(CURDATE())*1000 > estimated_time THEN 'COMPLETED'
        END AS status
        FROM
        follow_up_plan
        WHERE
        organization_id =#{orgId}
        <if test="resourceType == 'CUSTOMER'">
            AND customer_id = #{request.sourceId}
        </if>
        <if test="resourceType == 'CLUE'">
            AND clue_id = #{request.sourceId}
            AND create_user = #{userId}
        </if>
        <if test="resourceType == 'OPPORTUNITY'">
            AND opportunity_id = #{request.sourceId}
        </if>
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        <if test="orgId != null and orgId != ''">
            AND organization_id = #{orgId}
        </if>
        <if test="request.keyword != null and request.keyword != ''">
            AND content like concat('%', #{request.keyword},'%')
        </if>
        <if test="request.myPlan">
            AND owner = #{userId}
        </if>
        AND
        (
        #{request.status} = 'ALL'
        OR ( #{request.status} = 'CANCELLED' AND STATUS = 'CANCELLED' )
        OR ( #{request.status} = 'PREPARED' AND UNIX_TIMESTAMP(CURDATE())*1000 <![CDATA[<]]> estimated_time AND STATUS != 'CANCELLED' )
        OR ( #{request.status} = 'UNDERWAY' AND UNIX_TIMESTAMP(CURDATE())*1000 = estimated_time AND STATUS != 'CANCELLED' )
        OR ( #{request.status} = 'COMPLETED' AND UNIX_TIMESTAMP(CURDATE())*1000 > estimated_time AND STATUS != 'CANCELLED' )
        )

        <if test="customerData != null and !customerData.all and customerData.owner">
            <if test="customerData.userIds != null and customerData.userIds.size() > 0">
                AND owner not in
                <foreach collection="customerData.userIds" item="userId" open="(" close=")" separator=",">
                    #{userId}
                </foreach>
            </if>
        </if>

        <if test="customerData != null and !customerData.all and !customerData.owner and !customerData.self">
            <if test="customerData.userIds != null and customerData.userIds.size() > 0">
                AND owner not in
                <foreach collection="customerData.userIds" item="userId" open="(" close=")" separator=",">
                    #{userId}
                </foreach>
            </if>
        </if>

        <if test="customerData != null and !customerData.all and !customerData.owner and customerData.self">
            AND owner = #{userId}
        </if>

        <if test="resourceTypeList!=null and resourceTypeList.size()>0">
            AND type in
            <foreach collection="resourceTypeList" item="type" open="(" close=")" separator=",">
                <choose>
                    <when test="type == 'OPPORTUNITY'">
                        'CUSTOMER'
                    </when>
                    <otherwise>
                        #{type}
                    </otherwise>
                </choose>
            </foreach>
        and
            <foreach collection="resourceTypeList" item="type" open="(" close=")" separator="or">
                <if test="type == 'CUSTOMER'">
                    customer_id is not null
                </if>
                <if test="type == 'OPPORTUNITY'">
                    opportunity_id is not null
                </if>
                <if test="type == 'CLUE'">
                    clue_id is not null
                </if>

            </foreach>
        </if>

        ORDER BY estimated_time DESC
    </select>


    <select id="selectPlanByTimestamp" resultType="io.cordys.crm.follow.domain.FollowUpPlan">
        select fup.id, fup.customer_id, fup.opportunity_id, fup.clue_id, fup.organization_id, fup.owner, fup.estimated_time, fup.create_user
        FROM follow_up_plan fup
        INNER JOIN sys_user on sys_user.id = fup.`owner` and sys_user.id = fup.`create_user`
        WHERE estimated_time = #{timestamp}
    </select>

</mapper>