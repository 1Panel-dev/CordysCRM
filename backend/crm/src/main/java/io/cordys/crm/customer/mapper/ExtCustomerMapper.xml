<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.cordys.crm.customer.mapper.ExtCustomerMapper">
    <update id="batchTransfer">
        update customer
        set owner = #{request.owner},
            customer.collection_time = ${@java.lang.System@currentTimeMillis()},
            customer.update_time = ${@java.lang.System@currentTimeMillis()}, customer.update_user = #{userId}
        where owner != #{request.owner} and id in
        <foreach collection="request.ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <select id="list" resultType="io.cordys.crm.customer.dto.response.CustomerListResponse">
        select c.id, c.`name`, c.owner, c.create_time, c.update_time, c.create_user, c.update_user, c.collection_time, c.pool_id,
               c.follower, c.follow_time
                <if test="dataPermission != null and dataPermission.visible">
                    ,cc.collaboration_type
                </if>
        from customer c

        <include refid="fieldConditionJoin">
            <property name="conditions" value="request.filters"/>
            <property name="tablePrefix" value="filter"/>
        </include>
        <include refid="fieldConditionJoin">
            <property name="conditions" value="request.combineSearch.conditions"/>
            <property name="tablePrefix" value="combine"/>
        </include>
        <include refid="fieldSortJoin">
            <property name="sort" value="request.sort"/>
        </include>

        <if test="dataPermission != null and dataPermission.deptIds.size() > 0">
            join sys_organization_user sou on c.owner = sou.user_id
            and (
                sou.department_id in
                <foreach collection="dataPermission.deptIds" item="deptId" open="(" close=")" separator=",">
                    #{deptId}
                </foreach>
                <if test="dataPermission.searchType == 'ALL'">
                    or sou.user_id = #{userId}
                </if>
            )
        </if>

        <if test="dataPermission != null and dataPermission.visible">
            join customer_collaboration cc on c.id = cc.customer_id
            and cc.user_id = #{userId}
        </if>

        where c.organization_id = #{orgId}

        <if test="request.poolId == null">
            and c.in_shared_pool is false
        </if>

        <if test="request.poolId != null">
          and c.in_shared_pool is true and c.pool_id = #{request.poolId}
        </if>

        <if test="dataPermission != null and dataPermission.self">
          and c.owner = #{userId}
        </if>

        <if test="request.keyword != null and request.keyword != ''">
            and c.name like concat('%', #{request.keyword},'%')
        </if>

        <include refid="filters">
            <property name="filters" value="request.filters"/>
        </include>

        <include refid="combine">
            <property name="combineSearch" value="request.combineSearch"/>
        </include>

        <include refid="sort">
            <property name="sort" value="request.sort"/>
        </include>
    </select>

    <select id="sourceList" resultType="io.cordys.crm.customer.dto.response.CustomerListResponse">
        select distinct c.id, c.`name`, c.owner, c.create_time, c.update_time, c.create_user, c.update_user, c.collection_time, c.pool_id,
        c.follower, c.follow_time
        from customer c

        <include refid="fieldConditionJoin">
            <property name="conditions" value="request.filters"/>
            <property name="tablePrefix" value="filter"/>
        </include>
        <include refid="fieldConditionJoin">
            <property name="conditions" value="request.combineSearch.conditions"/>
            <property name="tablePrefix" value="combine"/>
        </include>
        <include refid="fieldSortJoin">
            <property name="sort" value="request.sort"/>
        </include>

        left join customer_collaboration cc on c.id = cc.customer_id
        where c.organization_id = #{orgId} and c.in_shared_pool is false
        <if test="userId != 'admin'">
            and ( (cc.user_id = #{userId} and collaboration_type = 'COLLABORATION') or c.owner = #{userId} )
        </if>
        <if test="request.keyword != null and request.keyword != ''">
            and c.name like concat('%', #{request.keyword},'%')
        </if>

        <include refid="filters">
            <property name="filters" value="request.filters"/>
        </include>

        <include refid="combine">
            <property name="combineSearch" value="request.combineSearch"/>
        </include>

        <include refid="sort">
            <property name="sort" value="request.sort"/>
        </include>
    </select>

    <sql id="sort">
        <choose>
            <when test="${sort} != null and ${sort}.valid()">
                <bind name="sortType" value="${sort}.type" />
                <bind name="sortName" value="${sort}.name" />
                order by
                <choose>
                    <when test="${sort}.name in
                        {'name', 'owner', 'create_time', 'update_time', 'follower', 'follow_time', 'create_user', 'update_user'}">
                        c.${sortName} ${sortType}
                    </when>
                    <otherwise>
                        sort_table.field_value ${sortType}
                    </otherwise>
                </choose>
            </when>
            <otherwise>
                order by c.create_time desc
            </otherwise>
        </choose>
    </sql>

    <sql id="fieldConditionJoin">
        <if test="${conditions} != null and ${conditions}.size() > 0">
            <foreach collection="${conditions}" item="condition" index="i">
                <if test="condition.name not in
                {'name', 'owner', 'createTime', 'updateTime', 'follower', 'followTime', 'createUser', 'updateUser', 'departmentId'}">
                    <if test="condition.multipleValue">
                        inner join customer_field_blob ${tablePrefix}_${i}
                        on c.id = ${tablePrefix}_${i}.resource_id and ${tablePrefix}_${i}.field_id = #{condition.name}
                    </if>
                    <if test="!condition.multipleValue">
                        inner join customer_field ${tablePrefix}_${i}
                        on c.id = ${tablePrefix}_${i}.resource_id and ${tablePrefix}_${i}.field_id = #{condition.name}
                    </if>
                </if>
                <if test="condition.name == 'departmentId'">
                    inner join sys_organization_user souc
                    on souc.user_id = c.owner
                </if>
            </foreach>
        </if>
    </sql>

    <sql id="fieldSortJoin">
        <if test="${sort} != null and ${sort}.valid() and ${sort}.name not in
                {'name', 'owner', 'create_time', 'update_time', 'follower', 'follow_time', 'create_user', 'update_user'}">
            <bind name="sortName" value="${sort}.name"/>
            left join customer_field sort_table
            on c.id = sort_table.resource_id and sort_table.field_id = #{sortName}
        </if>
    </sql>

    <sql id="filters">
        <if test="${filters} != null and ${filters}.size() > 0">
            <trim prefix="and">
                <foreach collection="${filters}" item="condition" open="(" close=")" index="i" separator="and">
                    <include refid="condition">
                        <property name="condition" value="condition"/>
                        <property name="fieldTable" value="filter_${i}.field_value"/>
                    </include>
                </foreach>
            </trim>
        </if>
    </sql>

    <sql id="combine">
        <if test="${combineSearch} != null and ${combineSearch}.conditions != null and ${combineSearch}.conditions.size() > 0">
            <trim prefix="and">
                <trim prefix="(" suffix=")" suffixOverrides="and|or">
                    <foreach collection="${combineSearch}.conditions" index="i" item="condition">
                        <include refid="condition">
                            <property name="condition" value="condition"/>
                            <property name="fieldTable" value="combine_${i}.field_value"/>
                        </include>
                        <include refid="io.cordys.common.mapper.CommonMapper.searchMode">
                            <property name="searchMode" value="${combineSearch}.searchMode"/>
                        </include>
                    </foreach>
                </trim>
            </trim>
        </if>
    </sql>

    <sql id="condition">
        <choose>
            <when test="condition.name == 'name'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.name"/>
                </include>
            </when>
            <when test="condition.name == 'owner'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.owner"/>
                </include>
            </when>
            <when test="condition.name == 'follower'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.follower"/>
                </include>
            </when>
            <when test="condition.name == 'followTime'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.follow_time"/>
                </include>
            </when>
            <when test="condition.name == 'createTime'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.create_time"/>
                </include>
            </when>
            <when test="condition.name == 'updateTime'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.update_time"/>
                </include>
            </when>
            <when test="condition.name == 'createUser'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.create_user"/>
                </include>
            </when>
            <when test="condition.name == 'updateUser'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="c.update_user"/>
                </include>
            </when>
            <when test="condition.name == 'departmentId'">
                <include refid="io.cordys.common.mapper.CommonMapper.condition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="souc.department_id"/>
                </include>
            </when>
            <otherwise>
                <include refid="io.cordys.common.mapper.CommonMapper.moduleFieldCondition">
                    <property name="condition" value="condition"/>
                    <property name="column" value="${fieldTable}"/>
                </include>
            </otherwise>
        </choose>
    </sql>

    <select id="checkAddExist" resultType="java.lang.Boolean">
        select count(1)
        from customer
        where name = #{customer.name} and organization_id = #{customer.organizationId} limit 1
    </select>

    <select id="checkUpdateExist" resultType="java.lang.Boolean">
        select count(1)
        from customer
        where name = #{customer.name}
        and organization_id = (
            select organization_id from customer where id = #{customer.id}
        )
        and id != #{customer.id} limit 1
    </select>

    <select id="selectOptionByIds" resultType="io.cordys.common.dto.OptionDTO">
        select id, name
        from customer
        where id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <select id="checkRepeatCustomerByName" resultType="io.cordys.crm.customer.dto.response.CustomerRepeatResponse">
        select c.id, c.name, c.owner, u.name as ownerName, c.create_time
        from customer c left join sys_user u on c.owner = u.id
        where c.name like concat('%', #{name},'%') and organization_id = #{orgId}
    </select>


    <select id="countByOwner" resultType="java.lang.Integer">
        select count(id) from customer
        where owner = #{owner}
    </select>

    <select id="getCustomerOptions" resultType="io.cordys.common.dto.OptionDTO">
        select id, name
        from customer
        where
        organization_id = #{orgId}
        <if test="keyword != null and keyword != ''">
            and name like concat('%', #{keyword},'%')
        </if>
    </select>
    <select id="getCustomerOptionsByIds" resultType="io.cordys.common.dto.OptionDTO">
        select id, name
        from customer
        where id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <update id="moveToPool" parameterType="io.cordys.crm.customer.domain.Customer">
        update customer set pool_id = #{customer.poolId}, in_shared_pool = #{customer.inSharedPool}, owner = #{customer.owner},
                            collection_time = #{customer.collectionTime}, update_time = #{customer.updateTime}, update_user = #{customer.updateUser}
        where id = #{customer.id}
    </update>

    <select id="hasRefOpportunity" resultType="java.lang.Boolean">
        select count(1) from opportunity where customer_id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
</mapper>