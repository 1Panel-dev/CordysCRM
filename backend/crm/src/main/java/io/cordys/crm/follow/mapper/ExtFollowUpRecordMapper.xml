<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.cordys.crm.follow.mapper.ExtFollowUpRecordMapper">

    <select id="selectList" resultType="io.cordys.crm.follow.dto.response.FollowUpRecordListResponse">
        SELECT
            id,
            customer_id,
            opportunity_id,
            type,
            clue_id,
            content,
            owner,
            contact_id,
            create_time,
            update_time,
            create_user,
            update_user
        FROM
            follow_up_record
        WHERE
            organization_id =#{orgId}
          and type = #{type}
        <if test="resourceType == 'CUSTOMER'">
            AND customer_id = #{request.sourceId}
        </if>
        <if test="resourceType == 'CLUE'">
            AND clue_id = #{request.sourceId}
            AND create_user = #{userId}
        </if>
        <if test="resourceType == 'OPPORTUNITY'">
            AND opportunity_id = #{request.sourceId}
        </if>
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        <if test="orgId != null and orgId != ''">
            AND organization_id = #{orgId}
        </if>
        <if test="request.keyword != null and request.keyword != ''">
            AND content like concat('%', #{request.keyword},'%')
        </if>
        ORDER BY create_time DESC
    </select>



    <select id="selectRecodes" resultType="io.cordys.common.dto.FollowUpRecordDTO">
        SELECT
        follow_up_record.`owner` AS follower,
        follow_up_record.create_time AS followTime,
        sys_user.name AS followerName,
        CASE
        WHEN #{resourceType} = 'CUSTOMER' THEN customer_id
        WHEN #{resourceType} = 'CLUE' THEN clue_id
        WHEN #{resourceType} = 'OPPORTUNITY' THEN opportunity_id
        END AS sourceId
        FROM
            follow_up_record
            inner join sys_user on follow_up_record.owner = sys_user.id
        WHERE
            type = #{type}
        <if test="resourceType == 'CUSTOMER'">
            AND customer_id in
            <foreach collection="sourceIds" item="sourceId" open="(" separator="," close=")">
                #{sourceId}
            </foreach>
        </if>
        <if test="resourceType == 'CLUE'">
            AND clue_id in
            <foreach collection="sourceIds" item="sourceId" open="(" separator="," close=")">
                #{sourceId}
            </foreach>
        </if>
        <if test="resourceType == 'OPPORTUNITY'">
            AND opportunity_id in
            <foreach collection="sourceIds" item="sourceId" open="(" separator="," close=")">
                #{sourceId}
            </foreach>
        </if>
    </select>
</mapper>